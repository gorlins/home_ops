---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
spec:
  chartRef:
    kind: HelmRepository
    name: authentik
  values:
    authentik:
      secret_key: "${{ secrets.secret_key }}"
      # This sends anonymous usage-data, stack traces on errors and
      # performance data to sentry.io, and is fully opt-in
      error_reporting:
        enabled: true
      postgresql:
        host: "${{ secrets.host }}"
        name: "${{ secrets.dbname }}"
        password: "${{ secrets.password }}"
        port: "${{ int secrets.port }}"
        user: "${{ secrets.username }}"

    server:
      ingress:
        # Specify kubernetes ingress controller class name
#        ingressClassName: nginx | traefik | kong
        enabled: false
#        hosts:
#          - authentik.domain.tld

    postgresql:
      enabled: false
#      auth:
#        password: "ThisIsNotASecurePassword"
    redis:
      enabled: true

---
# yaml-language-server: $schema=https://github.com/datreeio/CRDs-catalog/raw/refs/heads/main/gateway.networking.k8s.io/httproute_v1.json
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: authentik
spec:
  hostnames: ["authentik.${SECRET_DOMAIN}"]
  parentRefs:
    - name: external
      namespace: kube-system
      sectionName: https
  rules:
    - backendRefs:
        - name: authentik
          port: 80
      matches:
        - path:
            type: PathPrefix
            value: /
